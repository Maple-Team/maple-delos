FROM node:16 AS builder

WORKDIR app
COPY . .
# RUN npm install
# RUN npm install pnpm -g  --registry=https://registry.npmmirror.com/
# RUN npm run build
# RUN npm prune --production

RUN npm install -g pnpm --registry=https://registry.npmmirror.com/
RUN pnpm install --registry=https://registry.npmmirror.com/
RUN pnpm run build
RUN pnpm prune --prod

FROM node:16 AS production

WORKDIR app
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules

ENV NODE_ENV=production
EXPOSE 3000

CMD [ "sh", "-c", "npm run start:prod"]